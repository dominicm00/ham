# Copyright 2022, Dominic Martinez, dom@dominicm.dev
# Distributed under the terms of the MIT License.

#!multipleFiles
---
# Don't include missing sources in 'existing' actions
# target	- target
# source1	- source
# source2	- source (missing)
# source3	- source
#
#!file Jamfile
actions existing EchoExisting
{
	echo $(2) >> $(1)
}

LOCATE on target = . ;
LOCATE on source1 = . ;
LOCATE on source2 = . ;
LOCATE on source3 = . ;

EchoExisting target : source1 source2 source3 ;
Depends all : target ;
#!file source1
Already exists
#!file source3
Already exists
-
#!file target
./source1 ./source3
---
# Include all existing sources in 'existing' actions
# target	- target
# source1	- source
# source2	- source
# source3	- source
#
#!file Jamfile
actions existing EchoExisting
{
	echo $(2) >> $(1)
}

LOCATE on target = . ;
LOCATE on source1 = . ;
LOCATE on source2 = . ;
LOCATE on source3 = . ;

EchoExisting target : source1 source2 source3 ;
Depends all : target ;
#!file source1
Already exists
#!file source2
Already exists
#!file source3
Already exists
-
#!file target
./source1 ./source2 ./source3
---
# Don't run 'existing' actions without any existing sources
# target	- target
# source1	- source (missing)
# source2	- source (missing)
# source3	- source (missing)
#
#!file Jamfile
actions existing EchoAction
{
	echo $(2) >> $(1)
}

LOCATE on target = . ;
LOCATE on source1 = . ;
LOCATE on source2 = . ;
LOCATE on source3 = . ;

EchoAction target : source1 source2 source3 ;
Depends all : target ;
-
#!file target missing
---
# Updated modifier, independent targets
# target	- target
# source1	- source (missing)
# source2	- source (missing)
# source3	- source (missing)
#!file Jamfile
actions updated EchoAction
{
	echo $(2) >> $(1)
}

LOCATE on target = . ;
LOCATE on source1 = . ;
LOCATE on source2 = . ;
LOCATE on source3 = . ;

NOTFILE source2 ;
EchoAction target : source1 source2 source3 ;
Depends all : target ;
Depends target : source2 ;
-
#!exception
using independent target source1 in an 'updated' action
#!file target missing
---
# Updated modifier, independent targets, compatibility
# target	- target
# source1	- source (missing)
# source2	- source (missing)
# source3	- source (missing)
#!file Jamfile
#!compat jam boost !ham
actions updated EchoAction
{
	echo $(2) >> $(1)
}

LOCATE on target = . ;
LOCATE on source1 = . ;
LOCATE on source2 = . ;
LOCATE on source3 = . ;

NOTFILE source2 ;
EchoAction target : source1 source2 source3 ;
Depends all : target ;
Depends target : source2 ;
-
#!file target
./source1 ./source2 ./source3
---
# Updated modifier, some targets updated
# target	- target
# source1	- source (older)
# source2	- source (newer)
# source3	- source (older)
#!file Jamfile
rule JoinFiles
{
	Depends $(1) : $(2) ;
}

actions updated JoinFiles
{
	cat $(2) > $(1)
	echo "Updated" >> $(1)
}

LOCATE on target = . ;
JoinFiles target : source1 source2 source3 ;
Depends all : target ;

#!file target 1
Old
#!file source1 2
Source1
#!file source2 0
Source2
#!file source3 2
Source3
-
#!file target
Source2
Updated
---
# Updated modifier, all targets updated
# target	- target
# source1	- source (newer)
# source2	- source (newer)
# source3	- source (newer)
#!file Jamfile
rule JoinFiles
{
	Depends $(1) : $(2) ;
}

actions updated JoinFiles
{
	cat $(2) > $(1)
	echo "Updated" >> $(1)
}

LOCATE on target = . ;
JoinFiles target : source1 source2 source3 ;
Depends all : target ;

#!file target 1
Old
#!file source1
Source1
#!file source2
Source2
#!file source3
Source3
-
#!file target
Source1
Source2
Source3
Updated
---
# Updated modifier, no targets updated in an invocation
# target	- target
# source1	- source (older)
# source2	- source (newer)
# source3	- source (newer)
#!file Jamfile
rule JoinFiles
{
	Depends $(1) : $(2) ;
}

actions updated JoinFiles
{
	cat $(2) >> $(1)
	echo "Updated" >> $(1)
}

LOCATE on target = . ;
JoinFiles target : source1 ;
JoinFiles target : source2 ;
JoinFiles target : source3 ;
Depends all : target ;

#!file target 1
Old
#!file source1 2
Source1
#!file source2
Source2
#!file source3
Source3
-
#!file target
Old
Source2
Updated
Source3
Updated
---
# Updated modifier, targets updated indirectly
# oldTarget	- target (old)
# newTarget - target (new)
# source1	- source (directly updated)
# source2	- source (directly not updated)
# source3	- source (indirectly updated)
# source4	- source (indirectly not updated)
#!file Jamfile
rule JoinFiles
{
	Depends $(1) : $(2) ;
}

actions updated JoinFiles
{
	cat $(2) > $(1)
	echo "Updated" >> $(1)
}

LOCATE on newTarget = . ;
LOCATE on oldTarget = . ;
JoinFiles newTarget : source1 source2 source3 source4 ;

Depends newTarget : source1 source2 ;
Depends oldTarget : source3 source4 newTarget ;
Depends all : oldTarget ;

#!file oldTarget 3
Old
#!file newTarget 1
New
#!file source1
Source1
#!file source2 1
Source2
#!file source3 2
Source3
#!file source4 3
Source4
-
#!file newTarget
Source1
Source3
Updated
---
